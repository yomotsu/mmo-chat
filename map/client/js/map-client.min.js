var MOC=MOC||{};MOC.util={},MOC.util.getScreenPosition=function(e,r,t,a){return e.project(r),e.x=e.x*t+t,e.y=-(e.y*a)+a,{x:e.x,y:e.y}},MOC.util.cssTransform=function(e,r){e.style.webkitTransform=r,e.style.MozTransform=r,e.style.msTransform=r,e.style.transform=r},MOC.PlayerCharacter3D=function(e){this.id=e.id,this.chatID=e.chatID,this.name=e.name,this.mesh=new THREE.Mesh(new THREE.SphereGeometry(MOC.PlayerCharacter3D.PLAYER_RADIUS,16,16),new THREE.MeshBasicMaterial({color:16711680,wireframe:!0})),this.mesh.position.set(0,30,0),this.characterController=new MW.CharacterController(this.mesh,MOC.PlayerCharacter3D.PLAYER_RADIUS),this.DOMBlock=document.createElement("div"),this.DOMBlock.classList.add("MOC-view3d__playerDOMBlock"),this.DOMBlock.innerHTML=['<div class="MOC-view3d__playerChat" id="playerchat-'+this.chatID+'"></div>'].join(""),this.nameSprite=MOC.PlayerCharacter3D.generateNameSprite(this.name),this.nameSprite.position.set(0,1.5,0),this.mesh.add(this.nameSprite)},MOC.PlayerCharacter3D.prototype={updatePosition:function(){}},MOC.PlayerCharacter3D.PLAYER_RADIUS=1,MOC.PlayerCharacter3D.generateNameSprite=function(e){var r,t,a,n=512,i=64,o=46,l=.5*o+.5*i-5,c=document.createElement("canvas"),h=c.getContext("2d");c.width=n,c.height=i,h.font=o+"px sans-serif",h.textAlign="center",h.strokeStyle="#000",h.lineWidth=3,h.strokeText(e,n/2,l,n),h.fillStyle="#fff",h.fillText(e,n/2,l,n),r=new THREE.Texture(c),r.needsUpdate=!0,t=new THREE.SpriteMaterial({map:r,transparent:!1,fog:!0});var a=new THREE.Sprite(t);return a.scale.set(4,.5,0),a},MOC.view3d={init:function(e){this.width=window.innerWidth,this.height=window.innerHeight,this.clock=new THREE.Clock,this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(40,this.width/this.height,1,1e3),this.camera.position.set(0,5,30),this.renderer=new THREE.WebGLRenderer,this.renderer.setSize(this.width,this.height),e.appendChild(this.renderer.domElement),this.world=new MW.World;var r=new THREE.Vector3(-15,-15,-15),t=new THREE.Vector3(15,15,15),a=5;this.octree=new MW.Octree(r,t,a),this.world.add(this.octree),this.DOMContainer=document.createElement("div"),this.DOMContainer.style.width=this.width+"px",this.DOMContainer.style.height=this.height+"px",this.DOMContainer.classList.add("MOC-view3d__DOMContainer"),e.appendChild(this.DOMContainer),this.playerPool=[],this.addMe(),this.loadLevel()},addMe:function(){function e(){if(!r.playerCharacter.characterController.isIdling){var e=r.tpsCameraControl.getFrontAngle(),t=r.keyInputControl.getFrontAngle();r.playerCharacter.characterController.direction=THREE.Math.degToRad(360)-e+t}}var r=this;this.playerCharacter=new MOC.PlayerCharacter3D({chatID:MOC.playperModel.get("chatID"),name:MOC.playperModel.get("name"),type:MOC.playperModel.get("type")}),this.scene.add(this.playerCharacter.mesh),this.world.add(this.playerCharacter.characterController),this.DOMContainer.appendChild(this.playerCharacter.DOMBlock),this.keyInputControl=new MW.KeyInputControl,this.tpsCameraControl=new MW.TPSCameraControl(this.camera,this.playerCharacter.mesh,{el:this.renderer.domElement,offset:new THREE.Vector3(0,1.8,0),rigidObjects:[]}),this.playerCharacter.characterController.inputTimeout=null,this.keyInputControl.addEventListener("movekeyhold",function(){MOC.playperModel.get("isChatMode")||(r.playerCharacter.characterController.inputTimeout=null,r.playerCharacter.characterController.isRunning=!0)}),this.keyInputControl.addEventListener("movekeyrelease",function(){r.playerCharacter.characterController.inputTimeout=Date.now()+300,setTimeout(function(){r.keyInputControl.isMoveKeyHolded||(r.playerCharacter.characterController.isRunning=!1)},300)}),this.keyInputControl.addEventListener("jumpkeypress",function(){r.playerCharacter.characterController.jump()}),this.keyInputControl.addEventListener("movekeychange",e),this.tpsCameraControl.addEventListener("updated",e)},addOtherPlayer:function(e){var r=new MOC.PlayerCharacter3D({id:e.id,chatID:e.chatID,name:e.name,type:e.type});this.scene.add(r.mesh),this.world.add(r.characterController),this.playerPool.push(r),this.DOMContainer.appendChild(r.DOMBlock)},loadLevel:function(){var e,r,t=this,a=new THREE.JSONLoader;a.load(MOC.MAP_ROOT_DIR+"terrain.json",function(a,n){e=new THREE.Mesh(new THREE.BoxGeometry(14,1,5),new THREE.MeshNormalMaterial),e.position.set(-3,7.5,-13),t.scene.add(e),t.scene.add(new THREE.WireframeHelper(e)),t.octree.importThreeMesh(e),r=new THREE.Mesh(a,new THREE.MeshNormalMaterial),r.scale.set(2,2,2),t.scene.add(r),t.scene.add(new THREE.WireframeHelper(r)),t.octree.importThreeMesh(r),t.tpsCameraControl.rigidObjects.push(r)})},allOtherPlayersControler:function(){this.playerPool.forEach(function(e){})},update:function(){this.allOtherPlayersControler()},renderDOM:function(){var e,r,t,a,n=new THREE.Vector3,i=.25,o=(MOC.PlayerCharacter3D.PLAYER_RADIUS+i,function(e,o){n.addVectors(e.characterController.center,e.nameSprite.position),n.y+=i;var l=MOC.util.getScreenPosition(n,o,t,a);MOC.util.cssTransform(e.DOMBlock,"translate( "+l.x+"px, "+(l.y-r)+"px )")});return function(){var n=this.camera;e=this.width,r=this.height,t=.5*this.width,a=.5*this.height,o(this.playerCharacter,n),this.playerPool.forEach(function(e){o(e,n)})}}(),render:function(e){this.world.step(e),this.tpsCameraControl.update(),this.renderer.render(this.scene,this.camera)},connect:function(){var e=this,r=io("http://localhost:3004",{transports:["websocket"]});r.on("connect",function(){r.emit("addnewplayer",{chatID:MOC.playperModel.get("chatID"),name:MOC.playperModel.get("name"),type:MOC.playperModel.get("type"),position:[e.playerCharacter.characterController.center.x,e.playerCharacter.characterController.center.y,e.playerCharacter.characterController.center.z],velocity:[e.playerCharacter.characterController.velocity.x,e.playerCharacter.characterController.velocity.y,e.playerCharacter.characterController.velocity.z],direction:e.playerCharacter.characterController.direction,isGrounded:e.playerCharacter.characterController.isGrounded,isIdling:e.playerCharacter.characterController.isIdling,isJumping:e.playerCharacter.characterController.isJumping,isOnSlope:e.playerCharacter.characterController.isOnSlope,isRunning:e.playerCharacter.characterController.isRunning,jumpStartTime:e.playerCharacter.characterController.jumpStartTime,inputTimeout:e.playerCharacter.characterController.inputTimeout})}),r.on("myid",function(r){e.playerCharacter.id=r.myID;for(var t in r.players)e.addOtherPlayer(r.players[t])}),r.on("addnewplayer",function(r){e.addOtherPlayer(r)}),r.on("sync",function(t){e.playerPool.forEach(function(e){var r=t[e.id];e.characterController.center.set(r.position[0],r.position[1],r.position[2]),e.characterController.velocity.set(r.velocity[0],r.velocity[1],r.velocity[2]),e.characterController.direction=r.direction,e.characterController.isGrounded=r.isGrounded,e.characterController.isIdling=r.isIdling,e.characterController.isJumping=r.isJumping,e.characterController.isOnSlope=r.isOnSlope,e.characterController.isRunning=r.isRunning,e.characterController.jumpStartTime=r.jumpStartTime,e.characterController.inputTimeout=r.inputTimeout});var a={position:[e.playerCharacter.characterController.center.x,e.playerCharacter.characterController.center.y,e.playerCharacter.characterController.center.z],velocity:[e.playerCharacter.characterController.velocity.x,e.playerCharacter.characterController.velocity.y,e.playerCharacter.characterController.velocity.z],direction:e.playerCharacter.characterController.direction,isGrounded:e.playerCharacter.characterController.isGrounded,isIdling:e.playerCharacter.characterController.isIdling,isJumping:e.playerCharacter.characterController.isJumping,isOnSlope:e.playerCharacter.characterController.isOnSlope,isRunning:e.playerCharacter.characterController.isRunning,jumpStartTime:e.playerCharacter.characterController.jumpStartTime,inputTimeout:e.playerCharacter.characterController.inputTimeout};r.emit("upload",a)}),r.on("playerleft",function(r){e.dispose(r)})},dispose:function(e){var r=this.playerPool,t=this.world.characterPool,a=this.scene,n=this.DOMContainer,i=_.findIndex(r,{id:e}),o=r[i],l=(o.nameSprite,o.nameSprite.material.map),c=o.DOMBlock;o.mesh.remove(l),l.dispose(),o.mesh.remove(o.nameSprite),r.splice(r.indexOf(o),1),t.splice(t.indexOf(o.controller),1),a.remove(o.mesh),n.removeChild(c)}};